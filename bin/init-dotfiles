#!/usr/bin/env bash
#
# init-dotfiles
# Sets up symbolic links from home directory to dotfiles repository
# Compatible with: Git Bash, PowerShell, WSL2
#
# Usage: ./init-dotfiles
#

set -euo pipefail

# Enable native Windows symlinks in Git Bash/MSYS2
export MSYS=winsymlinks:nativestrict

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() { echo -e "${YELLOW}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_step() { echo -e "${BLUE}[STEP]${NC} $1"; }

# Detect if running on Windows (Git Bash, MSYS, Cygwin)
is_windows() {
    [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" || "$OSTYPE" == "win32" ]]
}

# Check if Windows Developer Mode is enabled
check_developer_mode() {
    if ! is_windows; then
        return 0  # Not Windows, no need for Developer Mode
    fi

    # Query the registry for Developer Mode setting using PowerShell
    local result
    result=$(powershell.exe -Command "(Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\AppModelUnlock' -Name 'AllowDevelopmentWithoutDevLicense' -ErrorAction SilentlyContinue).AllowDevelopmentWithoutDevLicense" 2>/dev/null | tr -d '\r\n')

    if [ "$result" = "1" ]; then
        return 0  # Developer Mode is enabled
    else
        return 1  # Developer Mode is not enabled
    fi
}

# Enable Windows Developer Mode (requires elevation)
enable_developer_mode() {
    log_step "Enabling Windows Developer Mode..."
    echo ""
    log_info "Developer Mode allows creating symbolic links without Administrator privileges."
    log_info "This is a one-time setup that requires elevation."
    echo ""

    # Create a temporary PowerShell script to enable Developer Mode
    local ps_script=$(mktemp --suffix=.ps1)
    cat > "$ps_script" << 'PWSH'
$ErrorActionPreference = "Stop"

Write-Host "Enabling Developer Mode..." -ForegroundColor Yellow

try {
    # Set the registry key to enable Developer Mode
    $regPath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\AppModelUnlock"

    if (-not (Test-Path $regPath)) {
        New-Item -Path $regPath -Force | Out-Null
    }

    Set-ItemProperty -Path $regPath -Name "AllowDevelopmentWithoutDevLicense" -Value 1 -Type DWord
    Set-ItemProperty -Path $regPath -Name "AllowAllTrustedApps" -Value 1 -Type DWord

    Write-Host "Developer Mode enabled successfully!" -ForegroundColor Green
    Write-Host ""
    Write-Host "IMPORTANT: You may need to restart Git Bash for changes to take effect." -ForegroundColor Cyan

} catch {
    Write-Host "Failed to enable Developer Mode: $_" -ForegroundColor Red
    exit 1
}
PWSH

    local win_ps_script=$(cygpath -w "$ps_script")

    # Run PowerShell script with elevation
    if powershell.exe -Command "Start-Process powershell.exe -ArgumentList '-ExecutionPolicy Bypass -File \"$win_ps_script\"' -Verb RunAs -Wait"; then
        rm -f "$ps_script"
        log_success "Developer Mode enabled!"
        echo ""
        log_info "Please restart Git Bash and run this script again."
        echo ""
        exit 0
    else
        rm -f "$ps_script"
        log_error "Failed to enable Developer Mode."
        return 1
    fi
}

# Create a symbolic link, backing up existing files
create_link() {
    local source="$1"
    local target="$2"
    local name="$3"

    if [ ! -e "$source" ]; then
        log_error "Source does not exist: $source"
        return 1
    fi

    # If target exists and is not a symlink, back it up
    if [ -e "$target" ] && [ ! -L "$target" ]; then
        local backup="${target}.backup.$(date +%Y%m%d%H%M%S)"
        log_info "Backing up existing $name to $backup"
        mv "$target" "$backup"
    fi

    # Remove existing symlink or file if present
    if [ -L "$target" ] || [ -e "$target" ]; then
        rm -rf "$target"
    fi

    # Create parent directory if needed
    mkdir -p "$(dirname "$target")"

    # Create symlink
    ln -sf "$source" "$target"

    # Verify symlink was created
    if [ -L "$target" ]; then
        log_success "Linked $name"
    else
        log_error "Failed to create symlink for $name"
        return 1
    fi
}

echo "=========================================="
echo "Dotfiles Initialization"
echo "=========================================="
echo ""
echo "Dotfiles directory: $DOTFILES_DIR"
echo "Home directory: $HOME"
echo ""

# ============================================================================
# Windows Developer Mode Check
# ============================================================================

if is_windows; then
    log_step "Checking Windows Developer Mode..."
    if check_developer_mode; then
        log_success "Developer Mode is enabled"
    else
        log_info "Developer Mode is not enabled"
        echo ""
        read -p "Would you like to enable Developer Mode now? (y/n) " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            enable_developer_mode
            # Script will exit after enabling, user needs to restart Git Bash
        else
            log_error "Developer Mode is required for symbolic links on Windows."
            log_info "You can enable it manually: Settings → Privacy & Security → For developers"
            exit 1
        fi
    fi
    echo ""
fi

# ============================================================================
# Claude Code Configuration
# ============================================================================

log_step "Setting up Claude Code configuration..."

# Ensure ~/.claude exists
mkdir -p ~/.claude

# Link Claude agents
if [ -d "$DOTFILES_DIR/.claude/agents" ]; then
    create_link "$DOTFILES_DIR/.claude/agents" "$HOME/.claude/agents" "Claude agents"
fi

# Link Claude commands
if [ -d "$DOTFILES_DIR/.claude/commands" ]; then
    create_link "$DOTFILES_DIR/.claude/commands" "$HOME/.claude/commands" "Claude commands"
fi

# Link Claude settings
if [ -f "$DOTFILES_DIR/.claude/settings.json" ]; then
    create_link "$DOTFILES_DIR/.claude/settings.json" "$HOME/.claude/settings.json" "Claude settings.json"
fi

# Link Claude CLAUDE.md
if [ -f "$DOTFILES_DIR/.claude/CLAUDE.md" ]; then
    create_link "$DOTFILES_DIR/.claude/CLAUDE.md" "$HOME/.claude/CLAUDE.md" "Claude CLAUDE.md"
fi

# ============================================================================
# Shell Configuration
# ============================================================================

log_step "Setting up shell configuration..."

# Link .bashrc
if [ -f "$DOTFILES_DIR/.bashrc" ]; then
    create_link "$DOTFILES_DIR/.bashrc" "$HOME/.bashrc" ".bashrc"
fi

# Link .bash_profile
if [ -f "$DOTFILES_DIR/.bash_profile" ]; then
    create_link "$DOTFILES_DIR/.bash_profile" "$HOME/.bash_profile" ".bash_profile"
fi

# Link .aliases
if [ -f "$DOTFILES_DIR/.aliases" ]; then
    create_link "$DOTFILES_DIR/.aliases" "$HOME/.aliases" ".aliases"
fi

# ============================================================================
# Git Configuration
# ============================================================================

log_step "Setting up git configuration..."

# Link .gitconfig
if [ -f "$DOTFILES_DIR/.gitconfig" ]; then
    create_link "$DOTFILES_DIR/.gitconfig" "$HOME/.gitconfig" ".gitconfig"
fi

# ============================================================================
# SSH Configuration
# ============================================================================

log_step "Setting up SSH configuration..."

# Ensure ~/.ssh exists with correct permissions
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# Link known_hosts
if [ -f "$DOTFILES_DIR/.ssh/known_hosts" ]; then
    create_link "$DOTFILES_DIR/.ssh/known_hosts" "$HOME/.ssh/known_hosts" ".ssh/known_hosts"
fi

echo ""
echo "=========================================="
log_success "Dotfiles initialization complete!"
echo "=========================================="
echo ""
echo "To sync on a new machine:"
echo "  1. Clone your dotfiles repo to ~/dotfiles"
echo "  2. Run: ~/dotfiles/bin/init-dotfiles"
echo ""
