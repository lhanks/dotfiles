#!/usr/bin/env bash
#
# init-dotfiles
# Sets up symbolic links from home directory to dotfiles repository
# Compatible with: Git Bash, PowerShell, WSL2
#
# Usage: ./init-dotfiles
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() { echo -e "${YELLOW}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Create a symbolic link, backing up existing files
create_link() {
    local source="$1"
    local target="$2"
    local name="$3"

    if [ ! -e "$source" ]; then
        log_error "Source does not exist: $source"
        return 1
    fi

    # If target exists and is not a symlink, back it up
    if [ -e "$target" ] && [ ! -L "$target" ]; then
        local backup="${target}.backup.$(date +%Y%m%d%H%M%S)"
        log_info "Backing up existing $name to $backup"
        mv "$target" "$backup"
    fi

    # Remove existing symlink if present
    if [ -L "$target" ]; then
        rm "$target"
    fi

    # Create parent directory if needed
    mkdir -p "$(dirname "$target")"

    # Create symlink
    ln -sf "$source" "$target"
    log_success "Linked $name"
}

echo "=========================================="
echo "Dotfiles Initialization"
echo "=========================================="
echo ""
echo "Dotfiles directory: $DOTFILES_DIR"
echo "Home directory: $HOME"
echo ""

# ============================================================================
# Claude Code Configuration
# ============================================================================

log_info "Setting up Claude Code configuration..."

# Ensure ~/.claude exists
mkdir -p ~/.claude

# Link Claude agents
if [ -d "$DOTFILES_DIR/.claude/agents" ]; then
    create_link "$DOTFILES_DIR/.claude/agents" "$HOME/.claude/agents" "Claude agents"
fi

# Link Claude commands
if [ -d "$DOTFILES_DIR/.claude/commands" ]; then
    create_link "$DOTFILES_DIR/.claude/commands" "$HOME/.claude/commands" "Claude commands"
fi

# Link Claude settings
if [ -f "$DOTFILES_DIR/.claude/settings.json" ]; then
    create_link "$DOTFILES_DIR/.claude/settings.json" "$HOME/.claude/settings.json" "Claude settings.json"
fi

# Link Claude CLAUDE.md
if [ -f "$DOTFILES_DIR/.claude/CLAUDE.md" ]; then
    create_link "$DOTFILES_DIR/.claude/CLAUDE.md" "$HOME/.claude/CLAUDE.md" "Claude CLAUDE.md"
fi

# ============================================================================
# Add more dotfile links here as needed
# ============================================================================

# Example: Git configuration
# if [ -f "$DOTFILES_DIR/.gitconfig" ]; then
#     create_link "$DOTFILES_DIR/.gitconfig" "$HOME/.gitconfig" ".gitconfig"
# fi

# Example: Bash configuration
# if [ -f "$DOTFILES_DIR/.bashrc" ]; then
#     create_link "$DOTFILES_DIR/.bashrc" "$HOME/.bashrc" ".bashrc"
# fi

echo ""
echo "=========================================="
log_success "Dotfiles initialization complete!"
echo "=========================================="
echo ""
echo "To sync on a new machine:"
echo "  1. Clone your dotfiles repo to ~/dotfiles"
echo "  2. Run: ~/dotfiles/bin/init-dotfiles"
echo ""
